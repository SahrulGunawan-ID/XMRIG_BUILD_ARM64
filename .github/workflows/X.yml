name: Build XMRig ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-arm64:
    name: Build Fully Static Binary for ARM64
    runs-on: ubuntu-latest

    steps:
      - name: Clone XMRig source
        run: |
          git clone https://github.com/xmrig/xmrig.git xmrig

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: arm64

      - name: Build Fully Static XMRig ARM64 in Docker
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}/xmrig:/xmrig \
            -w /xmrig \
            arm64v8/ubuntu:22.04 /bin/bash -c '
              set -ex

              apt update

              # Install required packages if not already installed
              for pkg in git build-essential cmake automake libtool autoconf curl pkg-config; do
                if ! dpkg -s "$pkg" >/dev/null 2>&1; then
                  apt install -y "$pkg"
                fi
              done

              # Build static libuv
              if [ ! -f /usr/local/lib/libuv.a ]; then
                git clone https://github.com/libuv/libuv.git
                cd libuv
                sh autogen.sh
                ./configure --disable-shared --enable-static
                make -j$(nproc)
                make install
                cd /xmrig
              fi

              # Build static hwloc
              if [ ! -f /usr/local/lib/libhwloc.a ]; then
                cd /
                git clone https://github.com/open-mpi/hwloc.git
                cd hwloc
                ./autogen.sh
                ./configure --disable-shared --enable-static
                make -j$(nproc)
                make install
                cd /xmrig
              fi

              # Build static OpenSSL
              if [ ! -f /usr/local/lib/libssl.a ]; then
                cd /
                curl -O https://www.openssl.org/source/openssl-1.1.1w.tar.gz
                tar xzf openssl-1.1.1w.tar.gz
                cd openssl-1.1.1w
                ./Configure linux-aarch64 no-shared --prefix=/usr/local
                make -j$(nproc)
                make install_sw
                cd /xmrig
              fi

              # Build XMRig
              mkdir -p build && cd build
              cmake .. \
                -DCMAKE_BUILD_TYPE=Release \
                -DWITH_HWLOC=ON \
                -DWITH_OPENCL=OFF \
                -DWITH_CUDA=OFF \
                -DWITH_HTTP=OFF \
                -DWITH_TLS=OFF \
                -DWITH_STATIC_LIBS=ON \
                -DCMAKE_EXE_LINKER_FLAGS="-static -L/usr/local/lib" \
                -DCMAKE_C_FLAGS="-static" \
                -DCMAKE_CXX_FLAGS="-static"
              make -j$(nproc)
              strip xmrig
            '

      - name: Upload Fully Static Binary
        uses: actions/upload-artifact@v4
        with:
          name: xmrig-arm64-fully-static
          path: xmrig/build/xmrig
